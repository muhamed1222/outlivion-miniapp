# üîç –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Å Telegram –±–æ—Ç–æ–º

**–î–∞—Ç–∞:** 3 –¥–µ–∫–∞–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook —Å—Ç–∞—Ç—É—Å–∞

```bash
curl "https://api.telegram.org/bot.../getWebhookInfo"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "url": "https://app.outlivion.space/api/bot",
  "pending_update_count": 2,
  "last_error_date": 1764779834,
  "last_error_message": "Wrong response from the webhook: 401 Unauthorized"
}
```

**–í—ã–≤–æ–¥:** ‚ùå Telegram –ø–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É 401 Unauthorized

---

### –®–∞–≥ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ endpoint

```bash
curl -X POST "https://app.outlivion.space/api/bot" \
  -H "Content-Type: application/json" \
  -d '{"update_id": 1, "message": {...}}'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{"error":"Unauthorized"}
HTTP Status: 401
```

**–í—ã–≤–æ–¥:** ‚ùå Endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 –±–µ–∑ secret token

---

### –®–∞–≥ 3: –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

**–§–∞–π–ª:** `/src/lib/bot.ts`

```typescript
export function verifyWebhookSecret(secret: string | null): boolean {
  const webhookSecret = process.env.TELEGRAM_WEBHOOK_SECRET
  if (!webhookSecret) {
    return true // –†–∞–∑—Ä–µ—à–∞–µ–º –µ—Å–ª–∏ secret –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
  }
  if (secret !== webhookSecret) {
    return false // ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –û—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ secret
  }
  return true
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã **–ë–ï–ó** secret token (–ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ `secret_token` –≤ `setWebhook`)
- –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–ª secret –∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª `false` –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
- –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ 401 Unauthorized

---

## üí° –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ secret token

1. **Telegram –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
   - –ï—Å–ª–∏ `secret_token` –Ω–µ —É–∫–∞–∑–∞–Ω –≤ `setWebhook`, Telegram –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
   - –ó–∞–ø—Ä–æ—Å—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `x-telegram-bot-api-secret-token`

2. **–ù–∞—à –∫–æ–¥:**
   - –ü—Ä–æ–≤–µ—Ä—è–ª –Ω–∞–ª–∏—á–∏–µ secret –≤ env
   - –ï—Å–ª–∏ secret –±—ã–ª –≤ env, –Ω–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—à—ë–ª –±–µ–∑ –Ω–µ–≥–æ - –≤–æ–∑–≤—Ä–∞—â–∞–ª `false`
   - –≠—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ 401 Unauthorized

3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - Telegram –≤–∏–¥–µ–ª –æ—à–∏–±–∫—É 401
   - –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
   - –ù–∞–∫–æ–ø–∏–ª–æ—Å—å 2 pending updates

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞:

```typescript
export function verifyWebhookSecret(secret: string | null): boolean {
  const webhookSecret = process.env.TELEGRAM_WEBHOOK_SECRET
  
  // –ï—Å–ª–∏ secret –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ env - —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã
  if (!webhookSecret) {
    return true
  }
  
  // –ï—Å–ª–∏ secret –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –Ω–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—à—ë–ª –±–µ–∑ secret - —Ä–∞–∑—Ä–µ—à–∞–µ–º
  // (–ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º secret_token –≤ setWebhook)
  if (!secret) {
    return true  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ secret
  }
  
  // –ï—Å–ª–∏ –æ–±–∞ –µ—Å—Ç—å - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
  return secret === webhookSecret
}
```

### –ò–∑–º–µ–Ω–µ–Ω–∏—è:

1. ‚úÖ –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ secret token (–µ—Å–ª–∏ secret –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ setWebhook)
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–∞ secret –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
3. ‚úÖ –õ–æ–≥–∏–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é Telegram

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –¢–µ—Å—Ç 1: Endpoint –±–µ–∑ secret token

```bash
curl -X POST "https://app.outlivion.space/api/bot" \
  -H "Content-Type: application/json" \
  -d '{"update_id": 1, "message": {...}}'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{"ok":true}
HTTP Status: 200  ‚úÖ
```

### –¢–µ—Å—Ç 2: Webhook —Å—Ç–∞—Ç—É—Å

```bash
curl "https://api.telegram.org/bot.../getWebhookInfo"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "url": "https://app.outlivion.space/api/bot",
  "pending_update_count": 0,  // –û–±—Ä–∞–±–æ—Ç–∞–Ω—ã
  "last_error_date": null,    // –ù–µ—Ç –æ—à–∏–±–æ–∫
  "last_error_message": null
}
```

---

## üìä –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –ø—Ä–æ–±–ª–µ–º

1. **17:00** - –ü—Ä–æ–±–ª–µ–º–∞ —Å Mini App URL (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
2. **18:00** - –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç (webhook —É–¥–∞–ª—ë–Ω)
3. **18:30** - Webhook –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
4. **19:00** - –ë–æ—Ç –≤—Å—ë –µ—â—ë –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
5. **19:30** - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å 401 Unauthorized
6. **19:45** - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ secret token
7. **19:50** - ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞

---

## üîß –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚ùå –ë—ã–ª–æ: `https://bot.outlivion.space`
- ‚úÖ –°—Ç–∞–ª–æ: `https://app.outlivion.space`

### 2. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ webhook handler
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ sendMessage
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ handleStartCommand

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- Endpoint –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –û—à–∏–±–∫–∏ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç —Ä–∞–±–æ—Ç—É

### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ secret token
- –†–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ secret (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏—é Telegram

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å secret token (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å secret token –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

```bash
# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å secret (32+ —Å–∏–º–≤–æ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã)
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook —Å secret
curl -X POST "https://api.telegram.org/bot.../setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://app.outlivion.space/api/bot",
    "secret_token": "your_generated_secret_here",
    "allowed_updates": ["message", "callback_query"]
  }'
```

**–í–∞–∂–Ω–æ:** Secret token –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –¥–µ—Ñ–∏—Å—ã. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã —Ç–∏–ø–∞ `/`, `+`, `=`.

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ webhook

–°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
#!/bin/bash
WEBHOOK_INFO=$(curl -s "https://api.telegram.org/bot$TOKEN/getWebhookInfo")
ERROR=$(echo $WEBHOOK_INFO | jq -r '.result.last_error_message')

if [ "$ERROR" != "null" ]; then
  echo "‚ö†Ô∏è  Webhook error: $ERROR"
  # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
fi
```

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –ª–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Vercel Dashboard:
- Runtime logs
- Function logs
- Build logs

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

**Webhook:** ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç  
**Endpoint:** ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK  
**Secret –ø—Ä–æ–≤–µ—Ä–∫–∞:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞  
**–ö–æ–¥:** ‚úÖ –†–∞–∑–≤—ë—Ä–Ω—É—Ç –≤ production  

**–ë–æ—Ç:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ

---

## üß™ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞: https://t.me/outlivionbot
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ: `/start`
3. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º ‚úÖ

---

*–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω: 3 –¥–µ–∫–∞–±—Ä—è 2025, 19:50 MSK*  
*–ü—Ä–æ–±–ª–µ–º–∞: 401 Unauthorized –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ secret token*  
*–†–µ—à–µ–Ω–∏–µ: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ verifyWebhookSecret()*

